\usepackage{keycommand}
\usepackage{fvextra}
\usepackage{float}
\usepackage{wrapfig}
\usepackage[labelformat=simple]{caption}
\usepackage[normalem]{ulem}

\captionsetup{margin=10pt, font=small, labelfont=bf, labelsep=endash}

% TODO: allow configuration
\definecolor{hint}{HTML}{A0A1A7}
\fvset{
    breaklines=true,
    numbers=left,
    frame=lines,
    numbersep=12pt,
    rulecolor=\color{hint},
    framesep=3\fboxsep,
    baselinestretch=0.8,
}
\newcounter{LirstingsLineNo}
\renewcommand{\theFancyVerbLine}{\ifnum\value{LirstingsLineNo}=0\else\footnotesize\ttfamily\color{hint}\arabic{LirstingsLineNo}\fi}

\newfloat{listing}{htbp}{lol}[chapter]
\floatname{listing}{Listing}
% sets for all custom floats with `plain` style
\captionsetup[plain]{skip=0pt}

\newcommand{\LirstInline}[2]{\ignorespaces\directlua{
    local escaped = string.gsub([[#2]], "'", [['"'"']])
    local handle, err = io.popen("lirstings inline '#1' '" .. escaped .. "'")

    if not handle then
        print(err)
        os.exit(1)
    end
    tex.print(handle:read('*all'))
    handle:close()
}\unskip}

\newkeycommand+[°]{\Lirsting}[
    ranges,
    caption,
    label,
    float,
    wrap,
    wrap width=0.5\textwidth,
    bool ansi=false,
    bool raw=false,
    bool raw queries=false,
    path prefix,
    fancyvrb,
    size,
][1]{
    °\def\commandargs{}°
%
    % set `--raw` flag if `raw` is true
    \if\commandkey{raw}1°\expandafter\def\expandafter\commandargs\expandafter{\commandargs%
        --raw
    }°\fi
    % set `--raw-queries` flag if `raw queries` is true
    \if\commandkey{raw queries}1°\expandafter\def\expandafter\commandargs\expandafter{\commandargs%
        --raw-queries
    }°\fi
    % set `--ranges` flag if `ranges` is set
    \ifcommandkey{ranges}{°\expandafter\def\expandafter\commandargs\expandafter{\commandargs%
        --ranges '\commandkey{ranges}'
    }°}{}
    % set `--filename-strip-prefix` flag if `path prefix` is set
    \ifcommandkey{path prefix}{°\expandafter\def\expandafter\commandargs\expandafter{\commandargs%
        --filename-strip-prefix '\commandkey{path prefix}'
    }°}{}
    % set `--fancyvrb-args` flag
    °\expandafter\def\expandafter\commandargs\expandafter{\commandargs%
        --fancyvrb-args '\commandkey{fancyvrb}'
    }°
    % set `--size` flag if `size` is set
    \ifcommandkey{size}{°\expandafter\def\expandafter\commandargs\expandafter{\commandargs%
        --size '\commandkey{size}'
    }°}{}
%
    % begin float if `float` is set
    \ifcommandkey{float}{°\begin{listing}°[\commandkey{float}]}{}
    \ifcommandkey{wrap}{°\begin{wrapfloat}{listing}°{\commandkey{wrap}}{\commandkey{wrap width}}}{}
    % actual input of code
    \if\commandkey{ansi}1%
        °\input°{|"lirstings ansi #1 °\commandargs°"}%
    \else%
        °\input°{|"lirstings tree-sitter #1 °\commandargs°"}%
    \fi
    % end float and set caption and label if `float` is set
    \ifcommandkey{float}{
            \ifcommandkey{caption}{°\caption{\commandkey{caption}}°}{}
            \ifcommandkey{label}{°\label{\commandkey{label}}°}{}
        °\end{listing}°
    }{}
    \ifcommandkey{wrap}{
            \ifcommandkey{caption}{°\caption{\commandkey{caption}}°}{}
            \ifcommandkey{label}{°\label{\commandkey{label}}°}{}
        °\end{wrapfloat}°
    }{}
}
